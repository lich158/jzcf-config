# 水果机配置管理系统 - 完整使用指南

## 从零开始搭建

### 第一步：环境准备

**系统要求**
- Python 3.7 或更高版本
- pip（Python包管理器）

**检查Python版本**
```bash
python3 --version
```

**安装依赖**
```bash
pip3 install fastapi uvicorn websockets
```

### 第二步：启动Web服务器

**启动服务器**
```bash
python3 web.py
```

**服务器启动成功后会显示**
```
INFO:     Started server process
INFO:     Uvicorn running on http://0.0.0.0:9091
INFO:     Application startup complete.
```

**访问地址**：http://localhost:9091

**登录信息**：
- 用户名：`lich`
- 密码：`123123`

### 第三步：启动App模拟器

**打开新的终端窗口**，运行：

```bash
python3 app_simulator.py
```

**模拟器会**：
1. 自动连接到WebSocket服务器（ws://localhost:9091/ws/app）
2. 接收服务器推送的初始配置
3. 持续监听配置更新
4. 显示详细的配置信息和验证结果

**输出示例**：
```
================================================================================
App模拟器启动
================================================================================
目标服务器: ws://localhost:9091/ws/app
等待连接...

✓ 已成功连接到服务器
等待接收配置数据...

################################################################################
收到消息 #1
时间: 2024-01-15 10:30:45
类型: update
################################################################################

共收到 9 个难度的配置:

================================================================================
【难度1】配置详情
================================================================================

【基础配置】
  比倍难度: 20%
  吃分最大值: 2,000
  吃分最小值: 300
  吃分返奖率: 80%
  营业返奖率: 83%

【开奖奖项】（每10000把出现的次数，总和应为10000）
  三倍小奖:  5150  (倍数:   3)
  苹果   :   900  (倍数:   5)
  橘子   :   700  (倍数:  10)
  柠檬   :   600  (倍数:  15)
  金钟   :   500  (倍数:  20)
  西瓜   :   500  (倍数:  20)
  双星   :   400  (倍数:  30)
  99     :   350  (倍数:  40)
  小bar  :   250  (倍数:  30)
  中bar  :   200  (倍数:  60)
  大bar  :   150  (倍数: 120)
  金猪奖 :   300  (加奖入口，无倍数)
  开奖总和: 10,000 ✓

【加奖奖项】（每10000把出现的次数，总和应为10000）
  双响炮  :  1100
  大四喜  :  1000
  小三元  :   900
  大三元  :   800
  彩金    :   700
  开火车  :   600
  统统有奖:   500
  大满贯  :   400
  仙女散花:   400
  小猫变身:  3600
  加奖总和: 10,000 ✓

【验证结果】✓ 配置有效
================================================================================
```

### 第四步：使用配置页面

1. **打开浏览器**，访问：http://localhost:9091
2. **登录**（用户名：lich，密码：123123）
3. **选择难度**：使用下拉框选择难度1-9
4. **查看配置**：页面显示当前难度的所有配置值
5. **修改配置**：在"输入新值"列中输入新值
6. **发送配置**：点击"发送配置"按钮

**配置发送后**：
- 服务器会更新配置并验证
- 自动广播给所有连接的App
- App模拟器会显示接收到的配置和验证结果

## 配置说明

### 基础配置

- **比倍难度**：比倍功能的难度百分比（0-100%）
- **吃分最大值**：吃分的最大值
- **吃分最小值**：吃分的最小值（必须 < 最大值）
- **吃分返奖率**：吃了100分，返给玩家的分数百分比
- **营业返奖率**：整体营业返奖率（包含加奖）

### 开奖奖项（每10000把出现的次数，总和应为10000）

| 奖项 | 倍数 | 说明 |
|------|------|------|
| 三倍小奖 | 3倍 | 基础奖项，占比47-51.5% |
| 苹果 | 5倍 | 低倍数奖项 |
| 橘子 | 10倍 | 低倍数奖项 |
| 柠檬 | 15倍 | 中倍数奖项 |
| 金钟 | 20倍 | 中倍数奖项 |
| 西瓜 | 20倍 | 中倍数奖项 |
| 双星 | 30倍 | 高倍数奖项 |
| 99 | 40倍 | 高倍数奖项 |
| 小bar | 30倍 | 高倍数奖项 |
| 中bar | 60倍 | 超高倍数奖项 |
| 大bar | 120倍 | 超高倍数奖项 |
| **金猪奖** | **加奖入口** | **无倍数，触发后进入加奖流程，占比3-7.5%** |

### 加奖奖项（每10000把出现的次数，总和应为10000）

- **双响炮**：加奖类型1
- **大四喜**：加奖类型2
- **小三元**：加奖类型3
- **大三元**：加奖类型4
- **彩金**：加奖类型5
- **开火车**：加奖类型6
- **统统有奖**：加奖类型7
- **大满贯**：加奖类型8
- **仙女散花**：加奖类型9
- **小猫变身**：10-30倍随机加奖（占比最大）

## 优化策略说明

### 开奖策略优化

**问题**：原配置三倍小奖太多（60-70%），金猪奖太少（1%），玩家没有兴趣继续玩

**优化方案**：
- **三倍小奖**：降低到47-51.5%（原60-70%），避免玩家感觉"总是小奖"
- **金猪奖**：增加到300-750（原80-100），提高加奖入口触发率3-7.5%
- **中高倍数**：保持一定概率，维持刺激感

**效果**：
- 玩家有更多机会触发加奖（金猪奖）
- 减少"总是小奖"的挫败感
- 提高游戏趣味性和参与度

### 难度设计

| 难度 | 返奖率 | 三倍小奖 | 金猪奖 | 策略目标 |
|------|--------|----------|--------|----------|
| 1 | 80% | 51.5% | 3.0% | 新手友好，建立信心 |
| 5 | 60% | 50.3% | 4.2% | 平衡刺激和盈利 |
| 9 | 40% | 47.0% | 7.5% | 最大化盈利，保持期待 |

## 数据格式

### 发送格式（难度作为key）

```json
{
  "难度1": {
    "比倍难度": 20,
    "吃分最大值": 2000,
    "三倍小奖": 5150,
    "金猪奖": 300,
    ...
  },
  "难度2": {
    ...
  }
}
```

### WebSocket消息格式

```json
{
  "type": "update",
  "timestamp": "2024-01-15T10:30:45",
  "data": {
    "难度1": {...},
    "难度2": {...}
  }
}
```

## 文件说明

### 核心文件

- `web.py` - 主服务器（FastAPI + WebSocket，端口9090）
- `backend.py` - 后端API服务（FastAPI + WebSocket，端口9091，生产环境）
- `lightweight_backend.py` - 轻量级后端API服务（FastAPI + WebSocket，端口9092，测试环境）
- `frontend.html` - 前端配置页面
- `app_simulator.py` - App模拟器（接收配置并验证）
- `difficulty_config.py` - 难度配置数组（优化后的配置）

### 工具文件

- `simulator.py` - 游戏模拟器（赔率分析）
- `optimize_odds.py` - 赔率优化器
- `start.sh` / `start.py` - 启动脚本
- `install_and_run_lightweight.sh` - 轻量级服务一键安装启动脚本

### 核心模块

- `core/game_config.py` - 游戏配置管理器

## 使用说明

### 启动服务

```bash
# 启动Web服务器
python3 web.py

# 启动后端API服务（生产环境，端口9091）
python3 backend.py

# 启动轻量级后端API服务（测试环境，端口9092）
python3 lightweight_backend.py

# 或者使用一键安装启动脚本（推荐）
./install_and_run_lightweight.sh

# 启动App模拟器（新终端）
python3 app_simulator.py
```

### 访问界面

- 前端配置界面: http://localhost:9090
- 后端API文档: http://localhost:9091/docs
- 轻量级后端API文档: http://localhost:9092/docs

### WebSocket端点

后端服务提供两个WebSocket端点：

1. `/ws/app` - 标准WebSocket端点，用于常规App连接
2. `/ws/lightweight` - 轻量级WebSocket端点，专为大量只读设备优化

#### 轻量级WebSocket端点特点

针对大量只接收数据的设备（如1万台设备），提供了专用的轻量级WebSocket端点：

**特点**：
1. 无心跳机制，减少CPU和网络开销
2. 无反向通信，设备不发送任何数据到服务器
3. 高效的连接管理，使用弱引用避免内存泄漏
4. 批量消息发送，提高广播效率

**使用方法**：
```bash
# 连接设备到轻量级WebSocket端点
python3 app_simulator.py --endpoint /ws/lightweight
```

**优化措施**：
1. 禁用了ping/pong心跳机制
2. 使用弱引用集合管理连接，避免内存泄漏
3. 并发发送消息给所有连接
4. 减少了队列大小和消息缓冲区
5. 移除了所有反向通信逻辑

这种设计可以显著降低服务器资源消耗，支持更大规模的设备连接。

### 测试工具

```bash
# 运行游戏模拟器
python3 simulator.py

# 运行赔率优化器
python3 optimize_odds.py
```

## 完整测试流程

### 1. 启动服务器

**终端1**：
```bash
cd /home/lich/jzcf-web
python3 web.py
```

**等待显示**：
```
INFO:     Uvicorn running on http://0.0.0.0:9091
```

### 2. 启动App模拟器

**终端2**：
```bash
cd /home/lich/jzcf-web
python3 app_simulator.py
```

**等待显示**：
```
✓ 已成功连接到服务器
等待接收配置数据...
```

### 3. 打开配置页面

**浏览器**：
- 访问：http://localhost:9091
- 登录：lich / 123123

### 4. 修改并发送配置

1. 选择难度（如：难度1）
2. 修改任意字段的值（如：金猪奖改为400）
3. 点击"发送配置"按钮

### 5. 查看结果

**在App模拟器中**：
- 会显示接收到的配置
- 显示验证结果
- 显示每个字段的值

**在浏览器中**：
- 显示"已发送给 X 个在线App"的提示

## 故障排除

### 问题1：端口被占用

```
Error: Address already in use
```

**解决**：
```bash
# 查找占用9091端口的进程
lsof -i :9091
# 或
netstat -tulpn | grep 9091

# 杀死进程
kill -9 <PID>
```

### 问题2：连接被拒绝

```
✗ 连接被拒绝
```

**解决**：
1. 确保服务器已启动（运行 `python3 web.py`）
2. 检查端口是否为9091
3. 检查防火墙设置

### 问题3：模块导入错误

```
ModuleNotFoundError: No module named 'fastapi'
```

**解决**：
```bash
pip3 install fastapi uvicorn websockets
```

### 问题4：配置总和错误

```
⚠ 开奖总和错误: 10050 (应为10000)
```

**解决**：
- 检查配置，确保开奖/加奖总和为10000
- 系统会自动调整，但建议手动修正

### 问题5：金猪奖为负数

```
⚠ 金猪奖为负数: -50
```

**解决**：
- 已修复：系统会自动从三倍小奖扣除，确保金猪奖不为负数
- 如果仍出现，检查其他奖项总和是否超过10000

## 重要说明

### 金猪奖的特殊性

- **金猪奖是加奖入口**，不是普通开奖奖项
- **没有倍数**，触发后会进入加奖流程
- **最小值为0**，不应为负数
- **占比3-7.5%**，让玩家有更多机会触发加奖

### 配置验证

系统会自动验证：
- ✅ 开奖总和 = 10000
- ✅ 加奖总和 = 10000
- ✅ 所有值 >= 0
- ✅ 金猪奖 >= 0
- ✅ 基础参数范围正确

### 端口配置

- **默认端口**：9091
- **Web地址**：http://localhost:9091
- **WebSocket地址**：ws://localhost:9091/ws/app

## 一键安装启动脚本

为了简化轻量级服务的部署，我们提供了一键安装启动脚本 [install_and_run_lightweight.sh](file:///home/lich/jzcf-config/install_and_run_lightweight.sh)。

该脚本会：
1. 检查并安装必要的依赖（fastapi, uvicorn, websockets）
2. 检查服务是否已在运行，如果运行则停止
3. 启动轻量级后端服务
4. 输出服务状态和日志信息

使用方法：
```bash
# 添加执行权限
chmod +x install_and_run_lightweight.sh

# 运行脚本
./install_and_run_lightweight.sh
```

服务将在后台运行，日志将输出到 `lightweight_backend.log` 文件中。

## 快速开始（一键启动）

```bash
# 1. 添加执行权限并运行一键安装启动脚本
chmod +x install_and_run_lightweight.sh
./install_and_run_lightweight.sh

# 2. 启动App模拟器（终端2）
python3 app_simulator.py

# 3. 打开浏览器访问
# http://localhost:9092
```

## 系统架构

```
┌─────────────┐
│  浏览器     │  HTTP Basic Auth
│  (前端)     │  ←→  http://localhost:9091
└─────────────┘
       │
       │ POST /send
       ↓
┌─────────────┐
│  Web服务器  │  FastAPI + WebSocket
│  (web.py)   │  ←→  ws://localhost:9091/ws/app
└─────────────┘
       │
       │ WebSocket广播
       ↓
┌─────────────┐
│ App模拟器   │  接收配置并验证
│ (app_sim...)│
└─────────────┘
```

## 技术支持

如有问题，请检查：
1. Python版本（需要3.7+）
2. 依赖包是否安装完整
3. 端口9091是否可用
4. 配置文件是否正确

---

**系统已优化完成，可以开始使用！**
